<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>할 일 리스트 (Todo)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="todo-app">
    <h1 class="h1_02">할 일 리스트</h1>

    <section class="todo-input">
      <input id="newTodo" type="text" placeholder="할 일을 입력하고 Enter 또는 추가 버튼을 눌러주세요" />
      <button id="addBtn" type="button">추가</button>
    </section>

    <section class="todo-controls">
      <div class="filters" role="group" aria-label="필터">
        <button type="button" data-filter="all" class="filter active">전체</button>
        <button type="button" data-filter="active" class="filter">진행중</button>
        <button type="button" data-filter="completed" class="filter">완료</button>
      </div>
      <div class="actions">
        <span id="itemsLeft">0개 남음</span>
        <button id="clearCompleted" type="button" class="secondary">완료 삭제</button>
      </div>
    </section>

    <ul id="todoList" class="todo-list" aria-live="polite"></ul>
  </main>

  <script>
    (function () {
      const STORAGE_KEY = 'todos_v1';
      let todos = load();
      let currentFilter = 'all';

      const $newTodo = document.getElementById('newTodo');
      const $addBtn = document.getElementById('addBtn');
      const $todoList = document.getElementById('todoList');
      const $filters = document.querySelectorAll('.filter');
      const $itemsLeft = document.getElementById('itemsLeft');
      const $clearCompleted = document.getElementById('clearCompleted');

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.warn('로컬 저장소 읽기 오류:', e);
          return [];
        }
      }

      function save() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
        } catch (e) {
          console.warn('로컬 저장소 저장 오류:', e);
        }
      }

      function render() {
        $todoList.innerHTML = '';
        const filtered = todos.filter(t => {
          if (currentFilter === 'active') return !t.completed;
          if (currentFilter === 'completed') return t.completed;
          return true; // all
        });

        for (const t of filtered) {
          const li = document.createElement('li');
          li.className = 'todo-item' + (t.completed ? ' completed' : '');
          li.dataset.id = t.id;

          li.innerHTML = `
            <label class="checkbox">
              <input type="checkbox" ${t.completed ? 'checked' : ''} aria-label="완료 표시">
              <span class="checkmark"></span>
            </label>
            <span class="title" contenteditable="true" spellcheck="false">${escapeHtml(t.title)}</span>
            <button class="delete" aria-label="삭제">×</button>
          `;

          // 이벤트 위임 대신 각 요소에 직접 등록 (규모가 작아 가독성 우선)
          li.querySelector('input[type="checkbox"]').addEventListener('change', () => toggle(t.id));
          li.querySelector('.delete').addEventListener('click', () => remove(t.id));
          li.querySelector('.title').addEventListener('blur', (e) => edit(t.id, e.target.textContent.trim()));
          li.querySelector('.title').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              e.target.blur();
            }
          });

          $todoList.appendChild(li);
        }

        const left = todos.filter(t => !t.completed).length;
        $itemsLeft.textContent = `${left}개 남음`;
      }

      function add(title) {
        const text = title.trim();
        if (!text) return;
        todos.push({ id: Date.now().toString(), title: text, completed: false });
        save();
        render();
      }

      function toggle(id) {
        const t = todos.find(x => x.id === id);
        if (!t) return;
        t.completed = !t.completed;
        save();
        render();
      }

      function remove(id) {
        todos = todos.filter(x => x.id !== id);
        save();
        render();
      }

      function edit(id, newTitle) {
        const t = todos.find(x => x.id === id);
        if (!t) return;
        t.title = newTitle || t.title; // 비어 있으면 기존 유지
        save();
        render();
      }

      function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
        render();
      }

      function clearCompleted() {
        todos = todos.filter(t => !t.completed);
        save();
        render();
      }

      function escapeHtml(str) {
        return str.replace(/[&<>"]+/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[s]));
      }

      // 초기 렌더링 및 이벤트
      render();

      $addBtn.addEventListener('click', () => {
        add($newTodo.value);
        $newTodo.value = '';
        $newTodo.focus();
      });

      $newTodo.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          add($newTodo.value);
          $newTodo.value = '';
        }
      });

      $filters.forEach(btn => btn.addEventListener('click', () => setFilter(btn.dataset.filter)));
      $clearCompleted.addEventListener('click', clearCompleted);
    })();
  </script>
</body>
</html>
